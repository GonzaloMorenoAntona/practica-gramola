<h2 style="text-align: center; margin: 20px 0; color: #333;">üé∂ La Gramola üé∂</h2>

<div style="text-align: center; margin-bottom: 20px;">
  <button (click)="toggleMode()" class="link-btn" style="background: #333; color: white; border-radius: 20px; padding: 5px 15px;">
    Modo Actual: <strong>{{ isAdmin ? 'DUE√ëO' : 'CLIENTE' }}</strong>
  </button>
</div>

<div class="dashboard-container">

  <div class="left-column" *ngIf="isAdmin">
    
    <div class="card">
      <div class="card-header">
        <strong class="card-title">Dispositivos</strong>
        <button class="link-btn" type="button" (click)="getDevices()">Actualizar</button>
      </div>

      <div class="list">
        <div class="row" *ngFor="let device of devices">
          <span>
            <span *ngIf="device.is_active">üé∂</span>
            {{ device.name }} - {{ device.type }} - {{ device.id }}
            <span *ngIf="device.is_active">üé∂</span>
          </span>
        </div>
      </div>
      <div class="error" *ngIf="deviceError">{{ deviceError }}</div>
    </div>

    <div class="card">
      <div class="card-header">
        <strong class="card-title">Playlists</strong>
        <button class="link-btn" type="button" (click)="getPlaylists()">Actualizar</button>
      </div>

      <div class="list">
        <div class="row" *ngFor="let p of playlists" 
             (click)="selectPlaylist(p)"
             style="cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; transition: background 0.2s;">
          
          <img [src]="p.images[0]?.url || 'assets/no-image.png'" 
               width="50" height="50" 
               style="border-radius: 4px; object-fit: cover; background: #333;"
               alt="Portada">
          
          <div style="overflow: hidden;">
            <span style="font-weight: bold; font-size: 1.1em; color: #222; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px;">
              {{ p.name }}
              </span>
            <small style="color: #666;">({{ p.tracks.total }} canciones)</small>
          </div>

        </div>
      </div>
      
      <div class="error" *ngIf="playlistError">{{ playlistError }}</div>
    </div>

  </div> 

  <div class="right-column" [class.full-width]="!isAdmin">

    <div class="card search-card" style="border-left: 5px solid #1db954;"> 
      <div class="card-header">
        <strong class="card-title">Buscar Canci√≥n</strong>
      </div>
      
      <div class="list" style="padding: 15px; display: flex; gap: 10px;">
        <input type="text" 
               [(ngModel)]="searchQuery" 
               (keyup.enter)="search()" 
               placeholder="Escribe t√≠tulo o artista" 
               style="flex-grow: 1; padding: 10px; font-size: 16px;">
               
        <button class="link-btn" (click)="search()">Buscar</button>
      </div>

      <div class="list" *ngIf="searchResults.length > 0" style="background: #f9f9f9; border-bottom: 1px solid #ddd;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee;">
            <h4 style="margin: 0;">Resultados:</h4>
            
            <button (click)="clearSearch()" 
                    style="background: #ff5555; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-weight: bold;">
                ‚úñ Cerrar
            </button>
        </div>
        
        <table style="width: 100%; border-collapse: collapse;">
          <tbody>
            <tr *ngFor="let track of searchResults" style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px;">
                <img [src]="track.album.images[2]?.url" width="40" style="vertical-align: middle; margin-right: 10px;">
                <span style="font-weight: bold;">{{ track.name }}</span>
                <br>
                <small style="color: #666;">{{ track.artists[0].name }}</small>
              </td>
              
              <td style="text-align: right;">
                <button class="link-btn" (click)="openPaymentModal(track)" style="background: #333; color: white;">
                  Comprar (1,00‚Ç¨)
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="error" *ngIf="searchError">{{ searchError }}</div>
    </div>

    <div class="card" *ngIf="currentTrack" style="background: linear-gradient(135deg, #1db954 0%, #101010 100%); color: white; border: none; margin-bottom: 25px;">
      
      <div class="card-header" style="background: transparent; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <strong class="card-title" style="font-size: 1.1em;">Sonando Ahora</strong>
      </div>

      <div class="list" style="padding: 25px; display: flex; align-items: center; gap: 20px;">
        
        <img [src]="currentTrack.album.images[0]?.url" 
             width="120" height="120" 
             style="border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit: cover;">
        
        <div style="flex-grow: 1;">
          <h2 style="margin: 0 0 10px 0; font-size: 2em; line-height: 1.1;">
            {{ currentTrack.name }}
          </h2>
          <p style="margin: 0; font-size: 1.3em; opacity: 0.9;">
            {{ currentTrack.artists[0].name }}
          </p>
          <small style="display: block; margin-top: 5px; opacity: 0.7; font-style: italic;">
            √Ålbum: {{ currentTrack.album.name }}
          </small>
        </div>

      </div>
    </div>

    <div class="card"> 
       
    <div class="card">
      <div class="card-header" style="background: #333; color: white;">
        <strong class="card-title">Canciones en la cola</strong>
        <br>
        <small style="font-size: 0.8em; color: #ccc;"></small>
      </div>

      <div class="list" *ngIf="queue.length > 0">
         </div>

      <div class="list" *ngIf="queue.length > 0">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="color: #888; text-align: left; border-bottom: 1px solid #ddd;">
              <th style="padding: 10px;">#</th>
              <th>Portada</th>
              <th>T√≠tulo</th>
              <th>Artista</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let track of queue; let i = index" style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;">{{ i + 1 }}</td>
              
              <td>
                <img [src]="track.album.images[0]?.url || 'assets/no-image.png'" 
                     width="40" height="40" 
                     style="border-radius: 4px; object-fit: cover; vertical-align: middle;">
              </td>

              <td style="font-weight: 500;">{{ track.name }}</td>
              <td style="color: #666;">{{ track.artists[0].name }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="list" *ngIf="queue.length === 0" style="padding: 20px; text-align: center; color: #666;">
        <p>üì≠ Spotify dice que la cola est√° vac√≠a.</p>
        <button (click)="getRealQueue()" style="color: #1db954; text-decoration: underline; background: none; border: none; cursor: pointer;">
            Prueba a refrescar
        </button>
      </div>
    </div>

    <div class="card" *ngIf="queue.length === 0">
      <div class="list" style="padding: 20px; text-align: center; color: #666;">
        <p>La cola est√° vac√≠a. Selecciona una playlist a la izquierda para cargar m√∫sica.</p>
      </div>
    </div>

  </div> 
</div> 

<div *ngIf="showPaymentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center;">
  
  <div style="background: white; padding: 30px; border-radius: 8px; width: 400px; text-align: center;">
    <h3>Confirmar Pago</h3>
    <p>Canci√≥n: <strong>{{ selectedTrack?.name }}</strong></p>
    <p>Precio: <strong style="color: #1db954;">1,00 ‚Ç¨</strong></p>

    <div style="margin: 20px 0; padding: 15px; border: 1px solid #ccc; background: #f9f9f9;">
      <div id="card-element"></div>
    </div>

    <div *ngIf="paymentError" style="color: red; margin-bottom: 10px;">{{ paymentError }}</div>

    <div style="display: flex; justify-content: space-between;">
      <button (click)="cancelPayment()" [disabled]="isProcessing" style="padding: 10px;">Cancelar</button>
      <button (click)="confirmPayment()" [disabled]="isProcessing" style="background: #1db954; color: white; padding: 10px; border: none; font-weight: bold;">
        {{ isProcessing ? 'Pagando...' : 'Pagar Ahora' }}
      </button>
    </div>
  </div>
</div>