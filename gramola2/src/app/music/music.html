<h2 style="text-align: center; margin: 20px 0; color: #333;">ðŸŽ¶ La Gramola ðŸŽ¶</h2>

<div style="text-align: center; margin-bottom: 20px;">
  <button (click)="toggleMode()" class="link-btn" style="background: #333; color: white; border-radius: 20px; padding: 5px 15px;">
    Modo Actual: <strong>{{ isAdmin ? 'DUEÃ‘O' : 'CLIENTE' }}</strong>
  </button>
</div>

<div class="dashboard-container">

  <div class="left-column" *ngIf="isAdmin">
    
    <div class="card">
      <div class="card-header">
        <strong class="card-title">Dispositivos</strong>
        <button class="link-btn" type="button" (click)="getDevices()">Actualizar</button>
      </div>

      <div class="list">
        <div class="row" *ngFor="let device of devices">
          <span>
            <span *ngIf="device.is_active">ðŸŽ¶</span>
            {{ device.name }} - {{ device.type }} - {{ device.id }}
            <span *ngIf="device.is_active">ðŸŽ¶</span>
          </span>
        </div>
      </div>
      <div class="error" *ngIf="deviceError">{{ deviceError }}</div>
    </div>

    <div class="card">
      <div class="card-header">
        <strong class="card-title">Playlists</strong>
        <button class="link-btn" type="button" (click)="getPlaylists()">Actualizar</button>
      </div>

      <div class="list">
        <div class="row" *ngFor="let p of playlists" 
             (click)="selectPlaylist(p)"
             style="cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; transition: background 0.2s;">
          
          <img [src]="p.images[0]?.url || 'assets/no-image.png'" 
               width="50" height="50" 
               style="border-radius: 4px; object-fit: cover; background: #333;"
               alt="Portada">
          
          <div style="overflow: hidden;">
            <span style="font-weight: bold; font-size: 1.1em; color: #222; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px;">
              {{ p.name }}
              </span>
            <small style="color: #666;">({{ p.tracks.total }} canciones)</small>
          </div>

        </div>
      </div>
      
      <div class="error" *ngIf="playlistError">{{ playlistError }}</div>
    </div>

  </div> 

  <div class="right-column" [class.full-width]="!isAdmin">

    <div class="card search-card" style="border-left: 5px solid #1db954;"> 
      <div class="card-header">
        <strong class="card-title">Buscar CanciÃ³n</strong>
      </div>
      
      <div class="list" style="padding: 15px; display: flex; gap: 10px;">
        <input type="text" 
               [(ngModel)]="searchQuery" 
               (keyup.enter)="search()" 
               placeholder="Escribe tÃ­tulo o artista" 
               style="flex-grow: 1; padding: 10px; font-size: 16px;">
               
        <button class="link-btn" (click)="search()">Buscar</button>
      </div>

      <div class="list" *ngIf="searchResults.length > 0">
        <h4 style="margin: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Resultados:</h4>
        
        <table style="width: 100%; border-collapse: collapse;">
          <tbody>
            <tr *ngFor="let track of searchResults" style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px;">
                <img [src]="track.album.images[2]?.url" width="40" style="vertical-align: middle; margin-right: 10px;">
                <span style="font-weight: bold;">{{ track.name }}</span>
                <br>
                <small style="color: #666;">{{ track.artists[0].name }}</small>
              </td>
              
              <td style="text-align: right;">
                <button class="link-btn" (click)="openPaymentModal(track)" style="background: #333; color: white;">
                  Comprar (1,00â‚¬)
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="error" *ngIf="searchError">{{ searchError }}</div>
    </div>

    <div class="card" *ngIf="queue.length > 0">
      <div class="card-header">
        <strong class="card-title">Canciones en Cola</strong>
        <small>({{ queue.length }} canciones)</small>
      </div>

      <div class="list">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="color: #888; text-align: left; border-bottom: 1px solid #ddd;">
              <th style="padding: 10px;">#</th>
              <th>Portada</th> <th>TÃ­tulo</th>
              <th>Artista</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let track of queue; let i = index" style="border-bottom: 1px solid #eee;">
              
              <td style="padding: 10px;">{{ i + 1 }}</td>
              
              <td>
                <img [src]="track.album.images[2]?.url || track.album.images[0]?.url" 
                    width="40" height="40" 
                    style="border-radius: 4px; object-fit: cover; vertical-align: middle;">
              </td>

              <td style="font-weight: 500;">{{ track.name }}</td>
              <td style="color: #666;">{{ track.artists[0].name }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card" *ngIf="queue.length === 0">
      <div class="list" style="padding: 20px; text-align: center; color: #666;">
        <p>La cola estÃ¡ vacÃ­a. Selecciona una playlist a la izquierda para cargar mÃºsica.</p>
      </div>
    </div>

  </div> 
</div> 

<div *ngIf="showPaymentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center;">
  
  <div style="background: white; padding: 30px; border-radius: 8px; width: 400px; text-align: center;">
    <h3>Confirmar Pago</h3>
    <p>CanciÃ³n: <strong>{{ selectedTrack?.name }}</strong></p>
    <p>Precio: <strong style="color: #1db954;">1,00 â‚¬</strong></p>

    <div style="margin: 20px 0; padding: 15px; border: 1px solid #ccc; background: #f9f9f9;">
      <div id="card-element"></div>
    </div>

    <div *ngIf="paymentError" style="color: red; margin-bottom: 10px;">{{ paymentError }}</div>

    <div style="display: flex; justify-content: space-between;">
      <button (click)="cancelPayment()" [disabled]="isProcessing" style="padding: 10px;">Cancelar</button>
      <button (click)="confirmPayment()" [disabled]="isProcessing" style="background: #1db954; color: white; padding: 10px; border: none; font-weight: bold;">
        {{ isProcessing ? 'Pagando...' : 'Pagar Ahora' }}
      </button>
    </div>
  </div>
</div>